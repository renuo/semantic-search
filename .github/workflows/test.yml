name: Run Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RAILS_ENV: test
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PGHOST: localhost
      PGUSER: postgres
      PGPASSWORD: postgres
      REDMINE_VERSION: 6.0.5

    services:
      postgres:
        image: ankane/pgvector:latest
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Cache Redmine
        id: cache-redmine
        uses: actions/cache@v3
        with:
          path: redmine
          key: redmine-${{ env.REDMINE_VERSION }}

      - name: Checkout redmine repository
        if: steps.cache-redmine.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: redmine/redmine
          path: redmine
          ref: ${{ env.REDMINE_VERSION }}

      - name: Checkout plugin
        uses: actions/checkout@v4
        with:
          path: redmine/plugins/semantic_search

      - name: Checkout redmine_sample_data plugin
        uses: actions/checkout@v4
        with:
          repository: alexandermeindl/redmine_sample_data
          path: redmine/plugins/redmine_sample_data

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          working-directory: redmine

      - name: Configure database
        working-directory: redmine
        run: |
          cat <<'EOF' > config/database.yml
          production:
            adapter: postgresql
            database: redmine
            host: localhost
            username: postgres
            password: "postgres"
            encoding: unicode

          development:
            adapter: postgresql
            database: redmine_development
            host: localhost
            username: postgres
            password: "postgres"
            encoding: unicode

          test:
            adapter: postgresql
            database: redmine_test
            host: localhost
            username: postgres
            password: "postgres"
            encoding: unicode
          EOF

      - name: Install dependencies
        working-directory: redmine
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev libxss1 libappindicator3-1 libindicator7
          bundle install --verbose
          echo "--- Installed pg gems ---"
          bundle exec gem list pg
          echo "--- Bundle platform ---"
          bundle platform
          echo "-----------------------"

      - name: Setup database
        working-directory: redmine
        run: |
          RAILS_ENV=test bundle exec rake db:create
          RAILS_ENV=test bundle exec rake db:migrate
          RAILS_ENV=test bundle exec rake redmine:plugins:migrate
          RAILS_ENV=test bundle exec rake redmine:sample_data

      - name: Enable pgvector extension
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d redmine_test -c "CREATE EXTENSION IF NOT EXISTS vector;"

      - name: Run tests
        working-directory: redmine
        run: |
          bundle exec rake redmine:plugins:test NAME=semantic_search
